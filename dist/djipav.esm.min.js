class t{constructor(){this.events={},this.suspended=!1}on(t,s,i={}){if("function"!=typeof s)throw new TypeError("The callback must be a function");const n={context:this,duration:1/0,data:void 0,prepend:!1,count:1/0};i=Object.assign({},n,i);const r=new e(t,this,s,i);return i.duration!==1/0&&setTimeout(()=>r.remove(),i.duration),this.events[t]||(this.events[t]=[]),i.prepend?this.events[t].unshift(r):this.events[t].push(r),r}static get ANY_EVENT(){return Symbol.for("Any event")}hasListener(t){return!!(this.events[t]&&this.events[t].length>0)}get eventNames(){return Object.keys(this.events)}getListeners(t){return this.events[t]||[]}suspend(t){this.getListeners(t).forEach(t=>{t.suspended=!0})}unsuspend(t){this.getListeners(t).forEach(t=>{t.suspended=!1})}getListenerCount(t){return this.getListeners(t).length}emit(e,s){if(!this.events[e]||this.suspended)return;let i=[],n=this.events[t.ANY_EVENT]||[];return this.events[e]&&(n=n.concat(this.events[e])),n.forEach(t=>{t.suspended||(t.count>0&&(void 0!==s?i.push(t.callback.call(t.context,s,t.data)):i.push(t.callback.call(t.context,t.data))),--t.count<1&&t.remove())}),i}off(t,e,s={}){if(!t)return void(this.events={});if(!this.events[t])return;let i=this.events[t].filter(t=>e&&t.callback!==e||s.count&&s.count!==t.count||s.context&&s.context!==t.context);i.length?this.events[t]=i:delete this.events[t]}get eventCount(){return Object.keys(this.events).length}}class e{constructor(t,e,s,i={}){const n={context:this,count:1/0,data:void 0};i=Object.assign({},n,i),this.event=t,this.target=e,this.callback=s,this.context=i.context,this.count=i.count,this.data=i.data,this.suspended=!1}remove(){this.target.off(this.event,this.callback,{context:this.context,count:this.count})}}class s extends t{constructor(t={}){super(),this.capture=null,this.constraints=!0,this.stream=null,this.timeouts={},this.video=this._parseAndBuildVideoElement(t)}async destroy(){this.cancelFade(),this.removeAllListeners(),await this.stop(),this.video&&this.video.hasAttribute("data-djipav")&&this.video.parentNode.removeChild(this.video),this.offScreenCanvas=null}async start(t={}){if(!this.started){if(!navigator.mediaDevices)return Promise.reject("MediaDevices API not supported.");if(this.opacity=0,t.constraints&&(this.constraints=t.constraints),this.stream=await navigator.mediaDevices.getUserMedia({deviceId:t.deviceId,video:this.constraints}),!ImageCapture)return Promise.reject("ImageCapture API not supported.");this.capture=new ImageCapture(this.track),this.offScreenCanvas=new OffscreenCanvas(this.settings.width,this.settings.height),this.video&&(this.video.srcObject=this.stream,await new Promise(t=>{this.video.addEventListener("canplay",()=>t())}),await this.video.play(),0!=t.visible&&await this.fadeIn(200))}}async stop(){this.started&&this.video&&this.video.srcObject&&(await this.fadeOut(200),this.video.pause(),this.stream.getTracks().forEach(t=>t.stop()),this.stream=null,this.capture=null,this.video.srcObject=null,this.video.src="")}async fadeIn(t=5e3){await this.fade("in",t)}async fadeOut(t=5e3){await this.fade("out",t)}async fade(t="in",e=5e3){this.cancelFade(),this.video&&(this.video.style.transitionDuration=parseInt(e)+"ms",this.opacity="in"!==t?0:1,await new Promise(s=>{this.timeouts.fadeOutTimeout=setTimeout(()=>{"in"!==t?this.emit("fadeoutdone"):this.emit("fadeindone"),s()},parseInt(e))}))}cancelFade(){if(clearTimeout(this.timeouts.fadeOutTimeout),clearTimeout(this.timeouts.fadeInTimeout),this.timeouts.fadeOutTimeout=null,this.timeouts.fadeInTimeout=null,!this.video)return;let t=window.getComputedStyle(this.video).getPropertyValue("opacity");this.opacity=t,this.emit("fadecancelled")}_parseAndBuildVideoElement(t={}){if("create"===t.element){let e=document.createElement("video");return t.elementId&&e.setAttribute("id",t.elementId),e.setAttribute("data-djipav","true"),document.body.append(e),e}return t.element?t.element:null}get capabilities(){return this.stream?this.stream.getVideoTracks()[0].getCapabilities():null}get opacity(){return this.video?Number.parseFloat(this.video.style.opacity):null}set opacity(t){if(!this.video)return null;this.video.style.opacity=Number.parseFloat(t)}get settings(){return this.stream&&this.track?this.track.getSettings():null}get started(){return!(!this.video&&!this.stream)&&(!(this.video||!this.stream)||this.video.currentTime>0&&!this.video.paused&&!this.video.ended&&this.video.readyState>=2)}get track(){return this.stream?this.stream.getVideoTracks()[0]:null}async grabFrame(t={}){let e=await this.capture.grabFrame();if("Blob"===t.format||"ObjectURL"===t.format){this.offScreenCanvas.getContext("2d").drawImage(e,0,0);let s=await this.offScreenCanvas.convertToBlob({type:t.mimeType,quality:t.quality});return"Blob"===t.format?s:URL.createObjectURL(s)}return e}async takePhoto(t={}){let e=await this.capture.takePhoto(t);return URL.createObjectURL(e)}}class i extends(o(AnalyserNode,new t)){constructor(t,e={}){super(t,e),this.volume=0,this.processor=this.context.createScriptProcessor(2048,1,1),this.connect(this.processor),this.processor.onaudioprocess=this.processAudioVolumeEvent.bind(this),this.processor.connect(this.context.destination)}destroy(){this.disconnect(),this.processor.onaudioprocess=null,this.processor.disconnect(),this.processor=null,this.removeAllListeners()}processAudioVolumeEvent(){let t=new Uint8Array(this.frequencyBinCount);this.getByteFrequencyData(t);let e=0;var s=t.length;for(let i=0;i<s;i++)e+=t[i]/255;let i=e/s;i!==this.volume&&(this.volume=i,this.emit("change",{type:"change",target:this,volume:this.volume}))}}class n extends t{constructor(){super(),this.constraints=!0,this.context=new AudioContext,this.meter=null}destroy(){this.stop()}async start(t={}){if(!navigator.mediaDevices)return Promise.reject("MediaDevices API not supported.");if(t.constraints&&(this.constraints=t.constraints),!t.deviceId){let e=(await a("audio")).filter(t=>"audioinput"===t.kind);t.deviceId=e[0].deviceId}this.stream=await navigator.mediaDevices.getUserMedia({deviceId:t.deviceId,audio:this.constraints}),this.source=this.context.createMediaStreamSource(this.stream),this.meter=new i(this.context),this.source.connect(this.meter),this.meter.on("change",t=>this.emit("volume",t.volume))}stop(){this.stream.getTracks().forEach(t=>t.stop()),this.stream=null,this.constraints=!0,this.source.disconnect(),this.meter.destroy(),this.meter=null}}function r(){return navigator.mediaDevices?navigator.mediaDevices.getSupportedConstraints():null}async function a(t){if(!navigator.mediaDevices)return Promise.resolve([]);let e=await navigator.mediaDevices.enumerateDevices(),s=e.filter(t=>"videoinput"===t.kind||"audioinput"===t.kind);if("audio"===t)return e.filter(t=>"audioinput"===t.kind);if("video"===t){return e.filter(t=>"videoinput"===t.kind).map(t=>{let{name:e,vendorId:s,productId:i}=function(t=""){let[,e,s,i]=t.match(/(.+) \(([0-9a-f]+):([0-9a-f]+)\)/i);return{name:e,vendorId:s=parseInt("0x"+s,16),productId:i=parseInt("0x"+i,16)}}(t.label);return t.vendorId=s,t.productId=i,t.name=e,t})}return s}function o(t,...e){class s extends t{}return e.forEach(t=>{for(let e in t)s.prototype[e]=t[e];Object.getOwnPropertyNames(Object.getPrototypeOf(t)).forEach(e=>{s.prototype[e]=t[e]})}),s}export{n as AudioInput,i as AudioMeter,s as VideoInput,a as getInputs,r as getSupportedConstraints,o as mix};
