class e{constructor(e=!1){this.map={},this.suspended=1==e}addListener(i,s,r={}){if("string"!=typeof i&&!(i instanceof String)&&i!==e.ANY_EVENT)throw new TypeError("The 'event' parameter must be a string or EventEmitter.ANY_EVENT.");if("function"!=typeof s)throw new TypeError("The callback must be a function.");const n=new t(i,this,s,r);return this.map[i]||(this.map[i]=[]),r.prepend?this.map[i].unshift(n):this.map[i].push(n),n}on(e,t,i={}){return this.addListener(e,t,i)}once(e,t,i={}){return i.remaining=1,this.addListener(e,t,i)}static get ANY_EVENT(){return Symbol.for("Any event")}hasListener(t){return void 0===t?!!(this.map[e.ANY_EVENT]&&this.map[e.ANY_EVENT].length>0)||Object.entries(this.map).some(([,e])=>e.length>0):!!(this.map[t]&&this.map[t].length>0)}get eventNames(){return Object.keys(this.map)}getListeners(e){return this.map[e]||[]}suspend(e){this.getListeners(e).forEach(e=>{e.suspended=!0})}unsuspend(e){this.getListeners(e).forEach(e=>{e.suspended=!1})}getListenerCount(e){return this.getListeners(e).length}emit(t,...i){if("string"!=typeof t&&!(t instanceof String))throw new TypeError("The 'event' parameter must be a string.");if(this.suspended)return;let s=[],r=this.map[e.ANY_EVENT]||[];return this.map[t]&&(r=r.concat(this.map[t])),r.forEach(e=>{if(e.suspended)return;let t=[...i];Array.isArray(e.args)&&(t=t.concat(e.args)),e.remaining>0&&(s.push(e.callback.apply(e.context,t)),e.count++),--e.remaining<1&&e.remove()}),s}removeListener(e,t,i={}){if(!e)return void(this.map={});if(!this.map[e])return;let s=this.map[e].filter(e=>t&&e.callback!==t||i.remaining&&i.remaining!==e.remaining||i.context&&i.context!==e.context);s.length?this.map[e]=s:delete this.map[e]}off(e,t,i={}){return this.removeListener(e,t,i)}get eventCount(){return Object.keys(this.map).length}}class t{constructor(t,i,s,r={}){if("string"!=typeof t&&!(t instanceof String)&&t!==e.ANY_EVENT)throw new TypeError("The 'event' parameter must be a string or EventEmitter.ANY_EVENT.");if(!i)throw new ReferenceError("The 'target' parameter is mandatory.");if("function"!=typeof s)throw new TypeError("The 'callback' must be a function.");void 0===r.args||Array.isArray(r.args)||(r.args=[r.args]),(r=Object.assign({context:i,remaining:1/0,args:void 0,duration:1/0},r)).duration!==1/0&&setTimeout(()=>this.remove(),r.duration),this.event=t,this.target=i,this.callback=s,this.context=r.context,this.remaining=parseInt(r.remaining)>=1?parseInt(r.remaining):1/0,this.count=0,this.args=r.args,this.suspended=!1}remove(){this.target.removeListener(this.event,this.callback,{context:this.context,remaining:this.remaining})}}class i extends e{constructor(e={}){super(),this.capture=null,this.constraints=!0,this.stream=null,this.timeouts={},this.video=this._parseAndBuildVideoElement(e),this.listeners={},this.recorder=null,this.recordedChunks=[]}async destroy(){this.cancelFade(),this.removeAllListeners(),await this.stop(),this.video&&this.video.hasAttribute("data-djipav")&&this.video.parentNode.removeChild(this.video),this.offScreenCanvas=null}async start(e={}){if(!this.started){if(!navigator.mediaDevices)return Promise.reject("MediaDevices API not supported.");if(this.opacity=0,e.constraints&&(this.constraints=e.constraints),this.stream=await navigator.mediaDevices.getUserMedia({deviceId:e.deviceId,video:this.constraints}),!ImageCapture)return Promise.reject("ImageCapture API not supported.");this.capture=new ImageCapture(this.track),this.offScreenCanvas=new OffscreenCanvas(this.settings.width,this.settings.height),this.video&&(this.video.srcObject=this.stream,await new Promise(e=>{this.video.addEventListener("canplay",()=>e())}),await this.video.play(),0!=e.visible&&await this.fadeIn(200))}}startRecording(e={}){if(!this.started||!this.stream||!window.MediaRecorder)throw new Error("MediaRecorder is not supported in your environment.");this.recordedChunks=[],this.listeners.onDataAvailable=e=>{e.data.size>0&&this.recordedChunks.push(e.data)},this.recorder=new MediaRecorder(this.stream,e),this.recorder.addEventListener("dataavailable",this.listeners.onDataAvailable),this.recorder.start(20)}async stopRecording(){return!this.recorder||this.recorder.state,new Promise(e=>{this.recorder.onstop=()=>{this.recorder.removeEventListener("dataavailable",this.listeners.onDataAvailable),this.listeners.onDataAvailable=void 0,this.recorder.stop=null,e()},this.recorder.stop()})}getRecordingAsObjectURL(){return URL.createObjectURL(this.getRecordingAsBlob())}getRecordingAsBlob(){return new Blob(this.recordedChunks,{type:"video/webm"})}async stop(){this.started&&this.video&&this.video.srcObject&&(await this.fadeOut(200),this.video.pause(),this.stream.getTracks().forEach(e=>e.stop()),this.stream=null,this.capture=null,this.video.srcObject=null,this.video.src="")}async fadeIn(e=5e3){await this.fade("in",e)}async fadeOut(e=5e3){await this.fade("out",e)}async fade(e="in",t=5e3){this.cancelFade(),this.video&&(this.video.style.transitionDuration=parseInt(t)+"ms",this.opacity="in"!==e?0:1,await new Promise(i=>{this.timeouts.fadeOutTimeout=setTimeout(()=>{"in"!==e?this.emit("fadeoutdone"):this.emit("fadeindone"),i()},parseInt(t))}))}cancelFade(){if(clearTimeout(this.timeouts.fadeOutTimeout),clearTimeout(this.timeouts.fadeInTimeout),this.timeouts.fadeOutTimeout=null,this.timeouts.fadeInTimeout=null,!this.video)return;let e=window.getComputedStyle(this.video).getPropertyValue("opacity");this.opacity=e,this.emit("fadecancelled")}_parseAndBuildVideoElement(e={}){if("create"===e.element){let t=document.createElement("video");return e.elementId&&t.setAttribute("id",e.elementId),t.setAttribute("data-djipav","true"),document.body.append(t),t}return e.element?e.element:null}get capabilities(){return this.stream?this.stream.getVideoTracks()[0].getCapabilities():null}get opacity(){return this.video?Number.parseFloat(this.video.style.opacity):null}set opacity(e){if(!this.video)return null;this.video.style.opacity=Number.parseFloat(e)}get settings(){return this.stream&&this.track?this.track.getSettings():null}get started(){return!(!this.video&&!this.stream)&&(!(this.video||!this.stream)||this.video.currentTime>0&&!this.video.paused&&!this.video.ended&&this.video.readyState>=2)}get track(){return this.stream?this.stream.getVideoTracks()[0]:null}async grabFrame(e={}){let t=await this.capture.grabFrame();if("Blob"===e.format||"ObjectURL"===e.format){this.offScreenCanvas.getContext("2d").drawImage(t,0,0);let i=await this.offScreenCanvas.convertToBlob({type:e.mimeType,quality:e.quality});return"Blob"===e.format?i:URL.createObjectURL(i)}return t}async takePhoto(e={}){let t=await this.capture.takePhoto(e);return URL.createObjectURL(t)}}class s extends(c(AnalyserNode,new e)){constructor(e,t={}){super(e,t),this.volume=0,this.processor=this.context.createScriptProcessor(2048,1,1),this.connect(this.processor),this.processor.onaudioprocess=this.processAudioVolumeEvent.bind(this),this.processor.connect(this.context.destination)}destroy(){this.disconnect(),this.processor.onaudioprocess=null,this.processor.disconnect(),this.processor=null,this.removeAllListeners()}processAudioVolumeEvent(){let e=new Uint8Array(this.frequencyBinCount);this.getByteFrequencyData(e);let t=0;var i=e.length;for(let s=0;s<i;s++)t+=e[s]/255;let s=t/i;s!==this.volume&&(this.volume=s,this.emit("change",{type:"change",target:this,volume:this.volume}))}}class r extends e{constructor(){super(),this.constraints=!0,this.context=new AudioContext,this.meter=null}destroy(){this.stop()}async start(e={}){if(!navigator.mediaDevices)return Promise.reject("MediaDevices API not supported.");if(e.constraints&&(this.constraints=e.constraints),!e.deviceId){let t=(await a("audio")).filter(e=>"audioinput"===e.kind);e.deviceId=t[0].deviceId}this.stream=await navigator.mediaDevices.getUserMedia({deviceId:e.deviceId,audio:this.constraints}),this.source=this.context.createMediaStreamSource(this.stream),this.meter=new s(this.context),this.source.connect(this.meter),this.meter.on("change",e=>this.emit("volume",e.volume))}stop(){this.stream.getTracks().forEach(e=>e.stop()),this.stream=null,this.constraints=!0,this.source.disconnect(),this.meter.destroy(),this.meter=null}}function n(){return navigator.mediaDevices?navigator.mediaDevices.getSupportedConstraints():null}async function a(e){if(!navigator.mediaDevices)return Promise.resolve([]);let t=await navigator.mediaDevices.enumerateDevices(),i=t.filter(e=>"videoinput"===e.kind||"audioinput"===e.kind);if("audio"===e)return t.filter(e=>"audioinput"===e.kind);if("video"===e){return t.filter(e=>"videoinput"===e.kind).map(e=>{let{name:t,vendorId:i,productId:s}=function(e=""){let[,t,i,s]=e.match(/(.+) \(([0-9a-f]+):([0-9a-f]+)\)/i);return{name:t,vendorId:i=parseInt("0x"+i,16),productId:s=parseInt("0x"+s,16)}}(e.label);return e.vendorId=i,e.productId=s,e.name=t,e})}return i}function o(){if(!window.MediaRecorder||!window.MediaRecorder.isTypeSupported)return[];return["audio/webm","audio/webm;codecs=opus","audio/ogg;codecs=opus","video/webm","video/webm;codecs=vp8","video/webm;codecs=vp8.0","video/webm;codecs=vp8,opus","video/WEBM;codecs=VP8,OPUS","video/webm;codecs=vp9","video/webm;codecs=vp9.0","video/webm;codecs=vp9,opus","video/webm;codecs=vp8,vp9,opus","video/webm;codecs=h264","video/webm;codecs=H264","video/webm;codecs=avc1","video/webm;codecs=h264,opus","video/webm;codecs=h264,vp9,opus","video/webm;codecs=daala","video/webm;codecs=h264","video/mpeg","video/x-matroska;codecs=avc1"].filter(e=>MediaRecorder.isTypeSupported(e))}function c(e,...t){class i extends e{}return t.forEach(e=>{for(let t in e)i.prototype[t]=e[t];Object.getOwnPropertyNames(Object.getPrototypeOf(e)).forEach(t=>{i.prototype[t]=e[t]})}),i}export{r as AudioInput,s as AudioMeter,i as VideoInput,a as getInputs,n as getSupportedConstraints,o as getSupportedRecordingTypes,c as mix};
