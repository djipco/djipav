var djipav=function(e){"use strict";function t(e,t,n,r,i,s,a){try{var o=e[s](a),u=o.value}catch(e){return void n(e)}o.done?t(u):Promise.resolve(u).then(r,i)}function n(e){return function(){var n=this,r=arguments;return new Promise(function(i,s){var a=e.apply(n,r);function o(e){t(a,i,s,o,u,"next",e)}function u(e){t(a,i,s,o,u,"throw",e)}o(void 0)})}}function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function s(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),e}function a(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&u(e,t)}function o(e){return(o=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function u(e,t){return(u=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function c(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function h(e,t){return!t||"object"!=typeof t&&"function"!=typeof t?c(e):t}function d(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=[],r=!0,i=!1,s=void 0;try{for(var a,o=e[Symbol.iterator]();!(r=(a=o.next()).done)&&(n.push(a.value),!t||n.length!==t);r=!0);}catch(e){i=!0,s=e}finally{try{r||null==o.return||o.return()}finally{if(i)throw s}}return n}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}class f{constructor(e,t,n,r,i,s){this.event=e,this.target=t,this.callback=n,this.context=r,this.once=1==i||!1,this.data=s,this.suspended=!1}remove(){this.target.off(this.event,this.callback,this.context,this.once)}}class l{constructor(){this.events={},this.suspended=!1}on(e,t,n,r,i){if("function"!=typeof t)throw new TypeError("The callback must be a function");let s=new f(e,this,t,n,r,i);return this.events[e]||(this.events[e]=[]),this.events[e].push(s),s}hasListener(e){return!!(this.events[e]&&this.events[e].length>0)}get eventNames(){return Object.keys(this.events)}getListeners(e){return this.events[e]||[]}suspend(e){this.getListeners(e).forEach(e=>{e.suspended=!0})}unsuspend(e){this.getListeners(e).forEach(e=>{e.suspended=!1})}getListenerCount(e){return this.getListeners(e).length}emit(e,t){this.events[e]&&!this.suspended&&this.events[e].forEach(e=>{e.suspended||(void 0!==t?e.callback.call(e.context,t,e.data):e.callback.call(e.context,e.data),e.once&&e.remove())})}once(e,t,n,r){return this.on(e,t,n,!0,r)}off(e,t,n,r){if(!this.events[e])return;let i=this.events[e].filter(e=>t&&e.callback!==t||r&&!e.once||n&&n!==e.context);i.length?this.events[e]=i:delete this.events[e]}removeAllListeners(){this.events={}}get eventCount(){return Object.keys(this.events).length}}var v=function(e){function t(){var e,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return r(this,t),(e=h(this,o(t).call(this))).capture=null,e.constraints=!0,e.stream=null,e.timeouts={},e.video=e._parseAndBuildVideoElement(n),e}return a(t,l),s(t,[{key:"destroy",value:function(){var e=n(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.cancelFade(),this.removeAllListeners(),e.next=4,this.stop();case 4:this.video&&this.video.hasAttribute("data-djipav")&&this.video.parentNode.removeChild(this.video),this.offScreenCanvas=null;case 6:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"start",value:function(){var e=n(regeneratorRuntime.mark(function e(){var t,n=this,r=arguments;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t=r.length>0&&void 0!==r[0]?r[0]:{},!this.started){e.next=3;break}return e.abrupt("return");case 3:if(navigator.mediaDevices){e.next=5;break}return e.abrupt("return",Promise.reject("MediaDevices API not supported."));case 5:return this.opacity=0,t.constraints&&(this.constraints=t.constraints),e.next=9,navigator.mediaDevices.getUserMedia({deviceId:t.deviceId,video:this.constraints});case 9:if(this.stream=e.sent,ImageCapture){e.next=12;break}return e.abrupt("return",Promise.reject("ImageCapture API not supported."));case 12:if(this.capture=new ImageCapture(this.track),this.offScreenCanvas=new OffscreenCanvas(this.settings.width,this.settings.height),!this.video){e.next=23;break}return this.video.srcObject=this.stream,e.next=18,new Promise(function(e){n.video.addEventListener("canplay",function(){return e()})});case 18:return e.next=20,this.video.play();case 20:if(0==t.visible){e.next=23;break}return e.next=23,this.fadeIn(200);case 23:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"stop",value:function(){var e=n(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.started&&this.video&&this.video.srcObject){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,this.fadeOut(200);case 4:this.video.pause(),this.stream.getTracks().forEach(function(e){return e.stop()}),this.stream=null,this.capture=null,this.video.srcObject=null,this.video.src="";case 10:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"fadeIn",value:function(){var e=n(regeneratorRuntime.mark(function e(){var t,n=arguments;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=n.length>0&&void 0!==n[0]?n[0]:5e3,e.next=3,this.fade("in",t);case 3:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"fadeOut",value:function(){var e=n(regeneratorRuntime.mark(function e(){var t,n=arguments;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=n.length>0&&void 0!==n[0]?n[0]:5e3,e.next=3,this.fade("out",t);case 3:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"fade",value:function(){var e=n(regeneratorRuntime.mark(function e(){var t,n,r=this,i=arguments;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t=i.length>0&&void 0!==i[0]?i[0]:"in",n=i.length>1&&void 0!==i[1]?i[1]:5e3,this.cancelFade(),this.video){e.next=5;break}return e.abrupt("return");case 5:return this.video.style.transitionDuration=parseInt(n)+"ms",this.opacity="in"!==t?0:1,e.next=9,new Promise(function(e){r.timeouts.fadeOutTimeout=setTimeout(function(){"in"!==t?r.emit("fadeoutdone"):r.emit("fadeindone"),e()},parseInt(n))});case 9:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"cancelFade",value:function(){if(clearTimeout(this.timeouts.fadeOutTimeout),clearTimeout(this.timeouts.fadeInTimeout),this.timeouts.fadeOutTimeout=null,this.timeouts.fadeInTimeout=null,this.video){var e=window.getComputedStyle(this.video).getPropertyValue("opacity");this.opacity=e,this.emit("fadecancelled")}}},{key:"_parseAndBuildVideoElement",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if("create"===e.element){var t=document.createElement("video");return e.elementId&&t.setAttribute("id",e.elementId),t.setAttribute("data-djipav","true"),document.body.append(t),t}return e.element?e.element:null}},{key:"grabFrame",value:function(){var e=n(regeneratorRuntime.mark(function e(){var t,n,r,i=arguments;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=i.length>0&&void 0!==i[0]?i[0]:{},e.next=3,this.capture.grabFrame();case 3:if(n=e.sent,"Blob"!==t.format&&"ObjectURL"!==t.format){e.next=17;break}return this.offScreenCanvas.getContext("2d").drawImage(n,0,0),e.next=9,this.offScreenCanvas.convertToBlob({type:t.mimeType,quality:t.quality});case 9:if(r=e.sent,"Blob"!==t.format){e.next=14;break}return e.abrupt("return",r);case 14:return e.abrupt("return",URL.createObjectURL(r));case 15:e.next=18;break;case 17:return e.abrupt("return",n);case 18:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"takePhoto",value:function(){var e=n(regeneratorRuntime.mark(function e(){var t,n,r=arguments;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=r.length>0&&void 0!==r[0]?r[0]:{},e.next=3,this.capture.takePhoto(t);case 3:return n=e.sent,e.abrupt("return",URL.createObjectURL(n));case 5:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"capabilities",get:function(){return this.stream?this.stream.getVideoTracks()[0].getCapabilities():null}},{key:"opacity",get:function(){return this.video?Number.parseFloat(this.video.style.opacity):null},set:function(e){if(!this.video)return null;this.video.style.opacity=Number.parseFloat(e)}},{key:"settings",get:function(){return this.stream&&this.track?this.track.getSettings():null}},{key:"started",get:function(){return!(!this.video&&!this.stream)&&(!(this.video||!this.stream)||this.video.currentTime>0&&!this.video.paused&&!this.video.ended&&this.video.readyState>=2)}},{key:"track",get:function(){return this.stream?this.stream.getVideoTracks()[0]:null}}]),t}(),p=function(e){function t(e){var n,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return r(this,t),(n=h(this,o(t).call(this,e,i))).volume=0,n.processor=n.context.createScriptProcessor(2048,1,1),n.connect(n.processor),n.processor.onaudioprocess=n.processAudioVolumeEvent.bind(c(n)),n.processor.connect(n.context.destination),n}return a(t,k(AnalyserNode,new l)),s(t,[{key:"destroy",value:function(){this.disconnect(),this.processor.onaudioprocess=null,this.processor.disconnect(),this.processor=null,this.removeAllListeners()}},{key:"processAudioVolumeEvent",value:function(){var e=new Uint8Array(this.frequencyBinCount);this.getByteFrequencyData(e);for(var t=0,n=e.length,r=0;r<n;r++)t+=e[r]/255;var i=t/n;i!==this.volume&&(this.volume=i,this.emit("change",{type:"change",target:this,volume:this.volume}))}}]),t}(),m=function(e){function t(){var e;return r(this,t),(e=h(this,o(t).call(this))).constraints=!0,e.context=new AudioContext,e.meter=null,e}return a(t,l),s(t,[{key:"destroy",value:function(){this.stop()}},{key:"start",value:function(){var e=n(regeneratorRuntime.mark(function e(){var t,n,r,i=this,s=arguments;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t=s.length>0&&void 0!==s[0]?s[0]:{},navigator.mediaDevices){e.next=3;break}return e.abrupt("return",Promise.reject("MediaDevices API not supported."));case 3:if(t.constraints&&(this.constraints=t.constraints),t.deviceId){e.next=10;break}return e.next=7,y("audio");case 7:n=e.sent,r=n.filter(function(e){return"audioinput"===e.kind}),t.deviceId=r[0].deviceId;case 10:return e.next=12,navigator.mediaDevices.getUserMedia({deviceId:t.deviceId,audio:this.constraints});case 12:this.stream=e.sent,this.source=this.context.createMediaStreamSource(this.stream),this.meter=new p(this.context),this.source.connect(this.meter),this.meter.on("change",function(e){return i.emit("volume",e.volume)});case 17:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"stop",value:function(){this.stream.getTracks().forEach(function(e){return e.stop()}),this.stream=null,this.constraints=!0,this.source.disconnect(),this.meter.destroy(),this.meter=null}}]),t}();function g(){var e=d((arguments.length>0&&void 0!==arguments[0]?arguments[0]:"").match(/(.+) \(([0-9a-f]+):([0-9a-f]+)\)/i),4),t=e[1],n=e[2],r=e[3];return{name:t,vendorId:n=parseInt("0x"+n,16),productId:r=parseInt("0x"+r,16)}}function y(e){return b.apply(this,arguments)}function b(){return(b=n(regeneratorRuntime.mark(function e(t){var n,r,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(navigator.mediaDevices){e.next=2;break}return e.abrupt("return",Promise.resolve([]));case 2:return e.next=4,navigator.mediaDevices.enumerateDevices();case 4:if(n=e.sent,r=n.filter(function(e){return"videoinput"===e.kind||"audioinput"===e.kind}),"audio"!==t){e.next=10;break}return e.abrupt("return",n.filter(function(e){return"audioinput"===e.kind}));case 10:if("video"!==t){e.next=15;break}return i=n.filter(function(e){return"videoinput"===e.kind}),e.abrupt("return",i.map(function(e){var t=g(e.label),n=t.name,r=t.vendorId,i=t.productId;return e.vendorId=r,e.productId=i,e.name=n,e}));case 15:return e.abrupt("return",r);case 16:case"end":return e.stop()}},e)}))).apply(this,arguments)}function k(e){for(var t=function(t){function n(){return r(this,n),h(this,o(n).apply(this,arguments))}return a(n,e),n}(),n=arguments.length,i=new Array(n>1?n-1:0),s=1;s<n;s++)i[s-1]=arguments[s];return i.forEach(function(e){for(var n in e)t.prototype[n]=e[n];Object.getOwnPropertyNames(Object.getPrototypeOf(e)).forEach(function(n){t.prototype[n]=e[n]})}),t}return e.AudioInput=m,e.AudioMeter=p,e.VideoInput=v,e.getInputs=y,e.getSupportedConstraints=function(){return navigator.mediaDevices?navigator.mediaDevices.getSupportedConstraints():null},e.mix=k,e}({});
