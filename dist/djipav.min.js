class Listener{constructor(t,e,i=!1){this.fn=t,this.context=e,this.once=!0===i||!1}}export class EventEmitter{constructor(){this._events={},this._eventsCount=0}addListener(t,e,i,s=!1){if("function"!=typeof e)throw new TypeError("The listener must be a function");let n=new Listener(e,i||this,s);return this._events[t]?this._events[t].fn?this._events[t]=[this._events[t],n]:this._events[t].push(n):(this._events[t]=n,this._eventsCount++),this}clearEvent(t){0==--this._eventsCount?this._events={}:delete this._events[t]}get eventNames(){let t,e,i=[];if(0===this._eventsCount)return i;for(e in t=this._events)Object.prototype.hasOwnProperty.call(t,e)&&i.push(e);return Object.getOwnPropertySymbols?i.concat(Object.getOwnPropertySymbols(t)):i}getListeners(t){let e=[],i=this._events[t];if(!i)return[];if(i.fn)return[i.fn];for(let t=0;t<i.length;t++)e[t]=i[t].fn;return e}getListenerCount(t){let e=this._events[t];return e?e.fn?1:e.length:0}emit(t,e,i,s,n,r){if(!this._events[t])return!1;let a,o,c=this._events[t],h=arguments.length;if(c.fn){switch(c.once&&this.removeListener(t,c.fn,void 0,!0),h){case 1:return c.fn.call(c.context),!0;case 2:return c.fn.call(c.context,e),!0;case 3:return c.fn.call(c.context,e,i),!0;case 4:return c.fn.call(c.context,e,i,s),!0;case 5:return c.fn.call(c.context,e,i,s,n),!0;case 6:return c.fn.call(c.context,e,i,s,n,r),!0}for(o=1,a=new Array(h-1);o<h;o++)a[o-1]=arguments[o];c.fn.apply(c.context,a)}else{let n,r=c.length;for(o=0;o<r;o++)switch(c[o].once&&this.removeListener(t,c[o].fn,void 0,!0),h){case 1:c[o].fn.call(c[o].context);break;case 2:c[o].fn.call(c[o].context,e);break;case 3:c[o].fn.call(c[o].context,e,i);break;case 4:c[o].fn.call(c[o].context,e,i,s);break;default:if(!a)for(n=1,a=new Array(h-1);n<h;n++)a[n-1]=arguments[n];c[o].fn.apply(c[o].context,a)}}return!0}on(t,e,i){return this.addListener(t,e,i,!1)}once(t,e,i){return this.addListener(t,e,i,!0)}removeListener(t,e,i,s){let n=[];if(!this._events[t])return this;if(!e)return this.clearEvent(t),this;let r=this._events[t];if(r.fn)r.fn!==e||s&&!r.once||i&&r.context!==i||this.clearEvent(t);else{for(let t=0,n=[],a=r.length;t<a;t++)(r[t].fn!==e||s&&!r[t].once||i&&r[t].context!==i)&&n.push(r[t]);n.length?this._events[t]=1===n.length?n[0]:n:this.clearEvent(t)}return this}removeAllListeners(t){return t?this._events[t]&&this.clearEvent(t):(this._events={},this._eventsCount=0),this}}export class VideoInput extends EventEmitter{constructor(t={}){super(),this.capture=null,this.constraints=!0,this.stream=null,this.timeouts={},this.video=this._parseAndBuildVideoElement(t)}async destroy(){this.cancelFade(),this.removeAllListeners(),await this.stop(),this.video&&this.video.hasAttribute("data-djipav")&&this.video.parentNode.removeChild(this.video),this.offScreenCanvas=null}async start(t={}){if(!this.started){if(!navigator.mediaDevices)return Promise.reject("MediaDevices API not supported.");if(this.opacity=0,t.constraints&&(this.constraints=t.constraints),this.stream=await navigator.mediaDevices.getUserMedia({deviceId:t.deviceId,video:this.constraints}),!ImageCapture)return Promise.reject("ImageCapture API not supported.");this.capture=new ImageCapture(this.track),this.offScreenCanvas=new OffscreenCanvas(this.settings.width,this.settings.height),this.video&&(this.video.srcObject=this.stream,await new Promise(t=>{this.video.addEventListener("canplay",()=>t())}),await this.video.play(),0!=t.visible&&await this.fadeIn(200))}}async stop(){this.started&&this.video&&this.video.srcObject&&(await this.fadeOut(200),this.video.pause(),this.stream.getTracks().forEach(t=>t.stop()),this.stream=null,this.capture=null,this.video.srcObject=null,this.video.src="")}async fadeIn(t=5e3){await this.fade("in",t)}async fadeOut(t=5e3){await this.fade("out",t)}async fade(t="in",e=5e3){this.cancelFade(),this.video&&(this.video.style.transitionDuration=parseInt(e)+"ms",this.opacity="in"!==t?0:1,await new Promise(i=>{this.timeouts.fadeOutTimeout=setTimeout(()=>{"in"!==t?this.emit("fadeoutdone"):this.emit("fadeindone"),i()},parseInt(e))}))}cancelFade(){if(clearTimeout(this.timeouts.fadeOutTimeout),clearTimeout(this.timeouts.fadeInTimeout),this.timeouts.fadeOutTimeout=null,this.timeouts.fadeInTimeout=null,!this.video)return;let t=window.getComputedStyle(this.video).getPropertyValue("opacity");this.opacity=t,this.emit("fadecancelled")}_parseAndBuildVideoElement(t={}){if("create"===t.element){let e=document.createElement("video");return t.elementId&&e.setAttribute("id",t.elementId),e.setAttribute("data-djipav","true"),document.body.append(e),e}return t.element?t.element:null}get capabilities(){return this.stream?this.stream.getVideoTracks()[0].getCapabilities():null}get opacity(){return this.video?Number.parseFloat(this.video.style.opacity):null}set opacity(t){if(!this.video)return null;this.video.style.opacity=Number.parseFloat(t)}get settings(){return this.stream&&this.track?this.track.getSettings():null}get started(){return!(!this.video&&!this.stream)&&(!(this.video||!this.stream)||this.video.currentTime>0&&!this.video.paused&&!this.video.ended&&this.video.readyState>=2)}get track(){return this.stream?this.stream.getVideoTracks()[0]:null}async grabFrame(t={}){let e=await this.capture.grabFrame();if("Blob"===t.format||"ObjectURL"===t.format){this.offScreenCanvas.getContext("2d").drawImage(e,0,0);let i=await this.offScreenCanvas.convertToBlob({type:t.mimeType,quality:t.quality});return"Blob"===t.format?i:URL.createObjectURL(i)}return e}async takePhoto(t={}){let e=await this.capture.takePhoto(t);return URL.createObjectURL(e)}}export class AudioInput extends EventEmitter{constructor(){super(),this.constraints=!0,this.context=new AudioContext,this.meter=null}destroy(){this.stop()}async start(t={}){if(!navigator.mediaDevices)return Promise.reject("MediaDevices API not supported.");if(t.constraints&&(this.constraints=t.constraints),!t.deviceId){let e=(await getInputs("audio")).filter(t=>"audioinput"===t.kind);t.deviceId=e[0].deviceId}this.stream=await navigator.mediaDevices.getUserMedia({deviceId:t.deviceId,audio:this.constraints}),this.source=this.context.createMediaStreamSource(this.stream),this.meter=new AudioMeter(this.context),this.source.connect(this.meter.input),this.meter.addListener("change",t=>this.emit("volume",t))}stop(){this.stream.getTracks().forEach(t=>t.stop()),this.stream=null,this.constraints=!0,this.source=this.context.createMediaStreamSource(this.stream),this.meter.destroy(),this.meter=null,this.meter.addListener("change",t=>this.emit("volume",t))}}export function getSupportedConstraints(){return navigator.mediaDevices?navigator.mediaDevices.getSupportedConstraints():null}function _parseWebcamInfoFromLabel(t=""){let[,e,i,s]=t.match(/(.+) \(([0-9a-f]+):([0-9a-f]+)\)/i);return{name:e,vendorId:i=parseInt("0x"+i,16),productId:s=parseInt("0x"+s,16)}}export async function getInputs(t){if(!navigator.mediaDevices)return Promise.resolve([]);let e=await navigator.mediaDevices.enumerateDevices(),i=e.filter(t=>"videoinput"===t.kind||"audioinput"===t.kind);if("audio"===t)return e.filter(t=>"audioinput"===t.kind);if("video"===t){return e.filter(t=>"videoinput"===t.kind).map(t=>{let{name:e,vendorId:i,productId:s}=_parseWebcamInfoFromLabel(t.label);return t.vendorId=i,t.productId=s,t.name=e,t})}return i}export class AudioMeter extends EventEmitter{constructor(t,e=.98,i=.95,s=750){super(),this.clippingLevel=e,this.clippingDelay=s,this.averaging=i,this.clipping=!1,this.lastClip=0,this.volume=0,this.context=t,this.input=this.context.createScriptProcessor(512),this.input.onaudioprocess=this.processAudioVolumeEvent.bind(this),this.input.connect(this.context.destination)}destroy(){this.input.disconnect(),this.input.onaudioprocess=null,this.removeAllListeners()}processAudioVolumeEvent(t){let e,i=t.inputBuffer.getChannelData(0),s=i.length,n=0;for(let t=0;t<s;t++)e=i[t],Math.abs(e)>=this.clippingLevel&&(this.clipping=!0,this.lastClip=window.performance.now()),n+=e*e;!this.clipping&&this.lastClip+this.clippingDelay<window.performance.now()&&(this.clipping=!1);let r=Math.sqrt(n/s);this.volume=Math.max(r,this.volume*this.averaging),this.emit("change",{type:"change",target:this,volume:this.volume,clipping:this.clipping})}}